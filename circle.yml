machine:
  node:
    version: 6.9.4

  services:
    - docker

  environment:
    PATH:        $PATH:/opt/google-cloud-sdk/bin
    REPO:        creasty/site
    K8S_VERSION: v1.5.7
    BRANCH:      $(echo $CIRCLE_BRANCH | sed -e 's/[^a-zA-Z0-9]/_/g')
    TAG:         $CIRCLE_BRANCH-${CIRCLE_SHA1::8}

    PROJECT_NAME:          creasty
    CLUSTER_NAME:          cluster-1
    CLOUDSDK_COMPUTE_ZONE: asia-east1-b
    DEBIAN_FRONTEND:       noninteractive

dependencies:
  cache_directories:
    - node_modules

  pre:
    - |
      set -e
      curl -o ./kubectl "https://storage.googleapis.com/kubernetes-release/release/${K8S_VERSION}/bin/linux/amd64/kubectl"
      chmod +x ./kubectl

    - |
      set -e
      sudo gcloud --quiet components update
      sudo gcloud --quiet components update kubectl
      echo "$GOOGLE_SERVICE_CRED" | base64 --decode -i > "${HOME}/account-auth.json"
      sudo gcloud auth activate-service-account --key-file "${HOME}/account-auth.json"
      sudo gcloud config set project "$PROJECT_NAME"
      sudo gcloud config set compute/zone "$CLOUDSDK_COMPUTE_ZONE"
      sudo gcloud --quiet config set container/cluster "$CLUSTER_NAME"
      sudo gcloud --quiet container clusters get-credentials "$CLUSTER_NAME"

  override:
    - yarn

test:
  override:
    - script/ci-build

deployment:
  production:
    commands: script/ci-deploy
